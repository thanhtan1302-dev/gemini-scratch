<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc C√πng B√© - Th·∫ø Gi·ªõi S·∫Øc M√†u</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800&display=swap');
        
        body { 
            font-family: 'Lexend', sans-serif; 
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #FFDEE9;
            background-image: linear-gradient(0deg, #FFDEE9 0%, #B5FFFC 100%);
        }

        .app-viewport { 
            width: 480px; 
            height: 480px; 
            overflow: hidden;
            position: relative;
            background: #ffffff;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            border: 6px solid #FF85A1;
            border-radius: 30px;
            display: flex;
            flex-direction: column;
        }

        .chat-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            background: #FFF9E3;
            background-image: radial-gradient(#FFD1D1 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .header-bg {
            background: #FF85A1;
            background: linear-gradient(90deg, #FF85A1 0%, #FFB7B2 100%);
        }

        .bubble-ai {
            background: white;
            border-radius: 18px 18px 18px 4px;
            border: 2px solid #FFB7B2;
            position: relative;
        }

        .bubble-user {
            background: #4facfe;
            background-image: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #FFB7B2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .dot {
            width: 6px;
            height: 6px;
            background: #FF85A1;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .suggestions-container {
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            background: white;
            white-space: nowrap;
            scrollbar-width: none;
            border-top: 1px solid #fce7f3;
        }
        .suggestions-container::-webkit-scrollbar { display: none; }
        
        .suggestion-chip {
            background: #fff1f2;
            color: #e11d48;
            border: 1px solid #fecdd3;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .suggestion-chip:hover {
            background: #ffe4e6;
            transform: scale(1.05);
        }

        .mic-active {
            animation: pulse-red 1s infinite;
            background-color: #ef4444 !important;
            color: white !important;
        }

        .speak-btn {
            font-size: 14px;
            color: #FF85A1;
            cursor: pointer;
            margin-left: 8px;
            vertical-align: middle;
        }

        .speak-btn.playing {
            color: #4ade80;
            animation: pulse-green 1s infinite;
        }

        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        @keyframes pulse-green {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <div class="app-viewport">
        <nav class="p-3 header-bg flex justify-center items-center z-50 shadow-md">
            <h1 class="text-white font-extrabold text-lg flex items-center gap-2">
                <span>üöÄ</span> KH√ÅM PH√Å C√ôNG B√â
            </h1>
        </nav>

        <div id="chat-messages" class="chat-container space-y-4">
            <div class="flex items-end gap-2">
                <div class="avatar shadow-sm">üë©‚Äçüè´</div>
                <div class="bubble-ai p-3 shadow-sm max-w-[80%] text-sm">
                    Ch√†o con y√™u! üåà C√¥ gi√°o r·∫•t vui ƒë∆∞·ª£c g·∫∑p con. H√¥m nay con mu·ªën h·ªçc g√¨ c√πng c√¥ n√†o? üçéüçì
                    <i class="fas fa-volume-up speak-btn" onclick="speakWithGemini(this, 'Ch√†o con y√™u! C√¥ gi√°o r·∫•t vui ƒë∆∞·ª£c g·∫∑p con. H√¥m nay con mu·ªën h·ªçc g√¨ c√πng c√¥ n√†o?')"></i>
                </div>
            </div>
        </div>

        <div id="suggestions-bar" class="suggestions-container"></div>

        <div class="p-3 bg-white border-t-2 border-pink-100">
            <div class="flex gap-2 items-center">
                <button id="mic-btn" class="w-10 h-10 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center transition-all hover:bg-pink-200 focus:outline-none">
                    <i class="fas fa-microphone"></i>
                </button>

                <input type="text" id="user-input" placeholder="Vi·∫øt ho·∫∑c n√≥i v·ªõi C√¥ nh√©..." 
                    class="flex-1 p-3 text-sm border-2 border-pink-200 rounded-2xl focus:outline-none focus:border-pink-400 bg-pink-50/30">
                
                <button id="send-btn" onclick="handleSend()" class="bg-pink-500 text-white w-10 h-10 rounded-full hover:bg-pink-600 shadow-lg transition flex items-center justify-center">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const _p1 = "AIzaSyD8t";
        const _p2 = "dberxxkY_9WKuqP";
        const _p3 = "qqZLYqw9_r5o07Q";
        const getK = () => apiKey || (_p1 + _p2 + _p3);

        const messagesContainer = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const suggestionsBar = document.getElementById('suggestions-bar');

        const initialSuggestions = ["H·ªçc to√°n c·ªông", "K·ªÉ chuy·ªán c·ªï t√≠ch", "T·∫≠p ƒë·ªçc v·∫ßn", "Khen con ƒëi"];

        function pcmToWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(0, 'RIFF');
            view.setUint32(4, 32 + pcmData.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmData.length * 2, true);
            for (let i = 0; i < pcmData.length; i++) view.setInt16(44 + i * 2, pcmData[i], true);
            return buffer;
        }

        async function speakWithGemini(btnElement, text) {
            if (btnElement) btnElement.classList.add('playing');
            const cleanText = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}]/gu, '');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${getK()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `ƒê·ªçc b·∫±ng gi·ªçng Ti·∫øng Vi·ªát vi-VN c·ª±c k·ª≥ ng·ªçt ng√†o, truy·ªÅn c·∫£m cho b√© l·ªõp 1: ${cleanText}` }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: "Leda" }
                                }
                            }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    })
                });

                const result = await response.json();
                const audioDataB64 = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                
                if (audioDataB64) {
                    const binaryString = atob(audioDataB64);
                    const pcmData = new Int16Array(binaryString.length / 2);
                    for (let i = 0; i < pcmData.length; i++) {
                        pcmData[i] = binaryString.charCodeAt(i * 2) | (binaryString.charCodeAt(i * 2 + 1) << 8);
                    }
                    
                    const wavBuffer = pcmToWav(pcmData, 24000);
                    const blob = new Blob([wavBuffer], { type: 'audio/wav' });
                    const audio = new Audio(URL.createObjectURL(blob));
                    audio.onended = () => { if (btnElement) btnElement.classList.remove('playing'); };
                    audio.play();
                }
            } catch (error) {
                console.error("TTS Error:", error);
                if (btnElement) btnElement.classList.remove('playing');
            }
        }

        function updateSuggestions(options) {
            suggestionsBar.innerHTML = '';
            options.forEach(text => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.innerText = text;
                chip.onclick = () => {
                    userInput.value = text;
                    handleSend();
                };
                suggestionsBar.appendChild(chip);
            });
        }

        updateSuggestions(initialSuggestions);

        let recognition;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'vi-VN';
            recognition.onstart = () => micBtn.classList.add('mic-active');
            recognition.onresult = (event) => {
                userInput.value = event.results[0][0].transcript;
                handleSend();
            };
            recognition.onend = () => micBtn.classList.remove('mic-active');
            micBtn.addEventListener('click', () => { try { recognition.start(); } catch (e) { recognition.stop(); } });
        }

        async function handleSend() {
            const text = userInput.value.trim();
            if (!text || sendBtn.disabled) return;

            addMessage(text, 'user');
            userInput.value = '';
            sendBtn.disabled = true;

            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex items-end gap-2 mb-4';
            typingDiv.innerHTML = `<div class="avatar">üë©‚Äçüè´</div><div class="bubble-ai p-3 shadow-sm flex gap-1"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const result = await callGeminiWithSuggestions(text);
                if (document.getElementById('typing-indicator')) document.getElementById('typing-indicator').remove();
                
                const aiMsgElement = addMessage(result.answer, 'ai');
                const btn = aiMsgElement.querySelector('.speak-btn');
                
                // T·ª∞ ƒê·ªòNG G·ªåI H√ÄM ƒê·ªåC SAU KHI C√ì C√ÇU TR·∫¢ L·ªúI
                speakWithGemini(btn, result.answer); 
                
                if (result.suggestions) updateSuggestions(result.suggestions);
            } catch (error) {
                if (document.getElementById('typing-indicator')) document.getElementById('typing-indicator').remove();
                addMessage("C√¥ b·∫≠n x√≠u, b√© ƒë·ª£i nh√©! üß∏", 'ai');
            } finally {
                sendBtn.disabled = false;
            }
        }

        async function callGeminiWithSuggestions(prompt) {
            const systemPrompt = `B·∫°n l√† c√¥ gi√°o d·∫°y l·ªõp 1. Tr·∫£ l·ªùi ng·ªçt ng√†o, x∆∞ng 'C√¥', g·ªçi 'con ∆°i', 'b√© y√™u'. Tr·∫£ l·ªùi d∆∞·ªõi 30 t·ª´. G·ª£i √Ω 3 c√¢u ti·∫øp theo ng·∫Øn. PH·∫¢N H·ªíI JSON: {"answer": "...", "suggestions": ["...", "...", "..."]}`;
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getK()}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            const data = await res.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4 items-end gap-2`;
            if (sender === 'ai') {
                div.innerHTML = `
                    <div class="avatar shadow-sm">üë©‚Äçüè´</div>
                    <div class="bubble-ai p-3 shadow-sm max-w-[80%] text-sm">
                        ${text}
                        <i class="fas fa-volume-up speak-btn" onclick="speakWithGemini(this, '${text.replace(/'/g, "\\'")}')"></i>
                    </div>`;
            } else {
                div.innerHTML = `<div class="bubble-user p-3 shadow-sm max-w-[80%] text-sm font-medium">${text}</div>`;
            }
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return div;
        }

        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });
    </script>
</body>
</html>
