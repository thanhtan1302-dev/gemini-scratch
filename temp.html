<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√© H·ªçc V·∫ßn AN - Ng·∫´u Nhi√™n & T·ªëc ƒê·ªô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #FFF9C4;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .card {
            transition: all 0.2s;
            cursor: pointer;
        }
        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .btn-speak {
            background-color: #FF7043;
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            box-shadow: 0 4px #D84315;
            transition: all 0.1s;
        }
        .btn-speak:active {
            box-shadow: 0 0;
            transform: translateY(2px);
        }
        .section { display: none; }
        .active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .star { color: #FFD600; font-size: 1.5rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .audio-loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

    <!-- Giao di·ªán ch√≠nh -->
    <div id="main-container" class="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-[10px] border-yellow-400">
        
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-400 to-blue-500 p-5 text-center">
            <h1 class="text-3xl font-bold text-white drop-shadow-md">B√â H·ªåC V·∫¶N AN</h1>
            <div class="flex justify-center mt-2 space-x-2">
                <span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span>
            </div>
        </div>

        <!-- N·ªôi dung -->
        <div class="p-6" id="app-content">
            
            <!-- Trang 1: Gi·ªõi thi·ªáu -->
            <div id="step-1" class="section active text-center">
                <h2 class="text-2xl text-pink-500 font-bold mb-4">1. L√†m quen v·∫ßn m·ªõi</h2>
                <div class="bg-yellow-50 rounded-3xl p-10 mb-6 border-4 border-dashed border-yellow-300">
                    <span class="text-9xl font-black text-blue-600 tracking-tighter">an</span>
                    <button id="btn-intro" onclick="speakText('v·∫ßn an. a n·ªù an')" class="btn-speak text-xl">üîä</button>
                </div>
                <div class="p-4 bg-gray-50 rounded-2xl mb-6 text-xl">
                    <p class="text-gray-700 font-medium">Ch·ªØ <b class="text-red-500">a</b> ƒë·ª©ng tr∆∞·ªõc</p>
                    <p class="text-gray-700 font-medium">Ch·ªØ <b class="text-blue-500">n</b> ƒë·ª©ng sau</p>
                </div>
                <button onclick="showStep(2)" class="w-full bg-green-500 text-white px-8 py-4 rounded-2xl font-bold text-xl shadow-[0_6px_0_rgb(22,163,74)] active:shadow-none active:translate-y-[4px]">Ti·∫øp t·ª•c n√†o! ‚ûú</button>
            </div>

            <!-- Trang 2: Gh√©p √¢m (Ng·∫´u nhi√™n) -->
            <div id="step-2" class="section text-center">
                <h2 class="text-2xl text-purple-500 font-bold mb-6">2. B√© t·∫≠p gh√©p ch·ªØ</h2>
                <div id="ghep-chu-container" class="space-y-4">
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n ng·∫´u nhi√™n b·ªüi JS -->
                </div>
                <div class="flex space-x-3 mt-8">
                    <button onclick="showStep(1)" class="bg-gray-200 text-gray-600 px-6 py-4 rounded-2xl font-bold">Quay l·∫°i</button>
                    <button onclick="showStep(3)" class="flex-1 bg-green-500 text-white px-8 py-4 rounded-2xl font-bold text-xl shadow-[0_6px_0_rgb(22,163,74)] active:shadow-none active:translate-y-[4px]">V√≠ d·ª• ‚ûú</button>
                </div>
            </div>

            <!-- Trang 3: V√≠ d·ª• -->
            <div id="step-3" class="section text-center">
                <h2 class="text-2xl text-red-500 font-bold mb-6">3. T·ª´ hay quanh b√©</h2>
                <div id="vi-du-container" class="grid grid-cols-2 gap-4">
                    <!-- D·ªØ li·ªáu v√≠ d·ª• ch√®n ·ªü ƒë√¢y -->
                </div>
                <button onclick="showStep(4)" class="mt-8 bg-green-500 text-white px-8 py-4 rounded-2xl font-bold text-xl shadow-[0_6px_0_rgb(22,163,74)] active:shadow-none active:translate-y-[4px] w-full">Tr√≤ ch∆°i! üéÆ</button>
            </div>

            <!-- Trang 4: Tr√≤ ch∆°i -->
            <div id="step-4" class="section text-center">
                <h2 class="text-2xl text-blue-600 font-bold mb-6">4. Th·ª≠ t√†i c·ªßa b√©</h2>
                <p class="mb-6 text-xl font-bold text-gray-700 bg-blue-50 py-3 rounded-full">Ti·∫øng n√†o c√≥ v·∫ßn <span class="text-red-500 underline">an</span>?</p>
                <div id="quiz-container" class="space-y-4">
                    <!-- ƒê√°p √°n ch√®n ng·∫´u nhi√™n ·ªü ƒë√¢y -->
                </div>
                <div id="feedback" class="mt-6 h-10 font-bold text-xl"></div>
                <button onclick="restartApp()" class="mt-4 text-blue-500 font-bold hover:underline">H·ªçc l·∫°i v·ªõi th·ª≠ th√°ch m·ªõi ‚Üª</button>
            </div>

        </div>
    </div>

    <script>
        const apiKey = "";
        let audioCache = {}; // L∆∞u tr·ªØ √¢m thanh ƒë·ªÉ ph√°t l·∫°i nhanh h∆°n

        const ghepChuList = [
            { text: "b + an = ban", speak: "b·ªù an ban", color: "orange" },
            { text: "l + an = lan", speak: "l·ªù an lan", color: "blue" },
            { text: "d + an + ` = d√†n", speak: "gi·ªù an gian huy·ªÅn d√†n", color: "pink" },
            { text: "m + an = man", speak: "m·ªù an man", color: "green" },
            { text: "ƒë + an = ƒëan", speak: "ƒë·ªù an ƒëan", color: "purple" }
        ];

        const viDuList = [
            { icon: "ü™ë", title: "C√°i b√†n", speak: "C√°i b√†n. B√© ng·ªìi v√†o b√†n h·ªçc.", color: "blue" },
            { icon: "üè∑Ô∏è", title: "Nh√£n v·ªü", speak: "Nh√£n v·ªü. Em d√°n nh√£n v√†o quy·ªÉn t·∫≠p.", color: "green" },
            { icon: "üåø", title: "D√†n m∆∞·ªõp", speak: "D√†n m∆∞·ªõp. D√†n m∆∞·ªõp n·ªü hoa v√†ng.", color: "yellow" },
            { icon: "ü™≥", title: "Con gi√°n", speak: "Con gi√°n. Con gi√°n b√≤ tr√™n t∆∞·ªùng.", color: "red" }
        ];

        const quizOptions = [
            { text: "Con c√°", correct: false },
            { text: "Nh√£n v·ªü", correct: true },
            { text: "Qu·∫£ kh·∫ø", correct: false },
            { text: "B√¥ng hoa", correct: false },
            { text: "C√°i b√†n", correct: true },
            { text: "Con m√®o", correct: false }
        ];

        // H√†m x√°o tr·ªôn m·∫£ng
        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        async function speakText(text) {
            // Ki·ªÉm tra cache ƒë·ªÉ ph√°t ngay l·∫≠p t·ª©c
            if (audioCache[text]) {
                playAudio(audioCache[text]);
                return;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Leda" } } }
                        }
                    })
                });

                const result = await response.json();
                const audioData = result.candidates[0].content.parts[0].inlineData.data;
                const mimeType = result.candidates[0].content.parts[0].inlineData.mimeType;
                const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)?.[1] || 24000);

                const wavBuffer = createWavFile(base64ToBuffer(audioData), sampleRate);
                const blob = new Blob([wavBuffer], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                
                audioCache[text] = url; // L∆∞u v√†o cache
                playAudio(url);
            } catch (error) {
                console.error("TTS Error:", error);
            }
        }

        function playAudio(url) {
            const audio = new Audio(url);
            audio.play();
        }

        function base64ToBuffer(base64) {
            const binary = atob(base64);
            const buffer = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) buffer[i] = binary.charCodeAt(i);
            return buffer.buffer;
        }

        function createWavFile(pcmBuffer, sampleRate) {
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const writeString = (view, offset, str) => {
                for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmBuffer.byteLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcmBuffer.byteLength, true);
            const wav = new Uint8Array(44 + pcmBuffer.byteLength);
            wav.set(new Uint8Array(header), 0);
            wav.set(new Uint8Array(pcmBuffer), 44);
            return wav.buffer;
        }

        function renderRandomContent() {
            // 1. Ng·∫´u nhi√™n gh√©p ch·ªØ (l·∫•y 3 c√°i)
            const ghepContainer = document.getElementById('ghep-chu-container');
            ghepContainer.innerHTML = '';
            shuffle([...ghepChuList]).slice(0, 3).forEach(item => {
                const div = document.createElement('div');
                div.className = `bg-${item.color}-50 p-5 rounded-2xl flex items-center justify-between border-2 border-${item.color}-200 shadow-sm`;
                div.innerHTML = `<span class="text-3xl font-bold text-${item.color}-600">${item.text}</span>
                                 <button onclick="speakText('${item.speak}')" class="btn-speak">üîä</button>`;
                ghepContainer.appendChild(div);
            });

            // 2. Ng·∫´u nhi√™n v√≠ d·ª•
            const viDuContainer = document.getElementById('vi-du-container');
            viDuContainer.innerHTML = '';
            shuffle([...viDuList]).forEach(item => {
                const div = document.createElement('div');
                div.className = `card bg-${item.color}-100 p-4 rounded-3xl border-2 border-${item.color}-200`;
                div.onclick = () => speakText(item.speak);
                div.innerHTML = `<div class="text-5xl mb-2">${item.icon}</div><div class="font-bold text-${item.color}-800">${item.title}</div>`;
                viDuContainer.appendChild(div);
            });

            // 3. Ng·∫´u nhi√™n Tr√≤ ch∆°i (1 ƒë√∫ng, 2 sai)
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = '';
            const correctOnes = quizOptions.filter(o => o.correct);
            const incorrectOnes = quizOptions.filter(o => !o.correct);
            const finalOptions = shuffle([
                shuffle(correctOnes)[0],
                ...shuffle(incorrectOnes).slice(0, 2)
            ]);

            finalOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full py-5 bg-white rounded-2xl text-2xl font-bold border-4 border-gray-100 shadow-sm transition-all active:scale-95";
                btn.innerText = opt.text;
                btn.onclick = () => checkAnswer(btn, opt.correct);
                quizContainer.appendChild(btn);
            });
        }

        function showStep(n) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('step-' + n).classList.add('active');
            
            const titles = [
                "Ch√†o c√°c con, h√¥m nay ch√∫ng m√¨nh h·ªçc v·∫ßn an",
                "B√© h√£y t·∫≠p gh√©p ch·ªØ c√πng c√¥ nh√©",
                "ƒê√¢y l√† c√°c v√≠ d·ª• v·ªÅ v·∫ßn an",
                "ƒê·ªë b√©, ti·∫øng n√†o c√≥ ch·ª©a v·∫ßn an?"
            ];
            speakText(titles[n-1]);
        }

        function checkAnswer(btn, isCorrect) {
            const feedback = document.getElementById('feedback');
            document.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('border-green-400', 'bg-green-100', 'border-red-400', 'bg-red-100');
            });

            if(isCorrect) {
                btn.classList.add('border-green-400', 'bg-green-100');
                feedback.innerText = "Gi·ªèi qu√°! ƒê√∫ng r·ªìi! üéâ";
                feedback.className = "mt-6 h-10 font-bold text-xl text-green-600";
                speakText("Gi·ªèi qu√°, ƒë√∫ng r·ªìi, b√© r·∫•t th√¥ng minh");
            } else {
                btn.classList.add('border-red-400', 'bg-red-100');
                feedback.innerText = "Ti·∫øc qu√°, th·ª≠ l·∫°i nh√©! ‚ùå";
                feedback.className = "mt-6 h-10 font-bold text-xl text-red-500";
                speakText("Ti·∫øc qu√°, b√© h√£y th·ª≠ l·∫°i nh√©");
            }
        }

        function restartApp() {
            renderRandomContent();
            showStep(1);
        }

        window.onload = () => {
            renderRandomContent();
            setTimeout(() => speakText("Ch√†o c√°c con, h√¥m nay ch√∫ng m√¨nh h·ªçc v·∫ßn an"), 1000);
        };
    </script>
</body>
</html>
